name: CI
permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install LLVM 18
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-18 llvm-18-dev clang-18 || true
          # Try to install Polly if available (may not exist in all repos)
          sudo apt-get install -y libpolly-18-dev 2>/dev/null || echo "Polly not available in repo"
          echo "LLVM_SYS_181_PREFIX=/usr/lib/llvm-18" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/lib/llvm-18/lib:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
          # Set library search path for linker
          echo "LIBRARY_PATH=/usr/lib/llvm-18/lib:${LIBRARY_PATH:-}" >> $GITHUB_ENV
      
      - name: Install LLVM 18 (macOS)
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          brew install llvm@18 || brew reinstall llvm@18
          echo "LLVM_SYS_181_PREFIX=$(brew --prefix llvm@18)" >> $GITHUB_ENV
          echo "$(brew --prefix llvm@18)/bin" >> $GITHUB_PATH
        env:
          HOMEBREW_NO_INSTALL_CLEANUP: 1
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Install LLVM 18.1 (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          if (-not (Get-Command cargo -ErrorAction SilentlyContinue)) {
            throw "cargo is required to install llvmenv"
          }

          Write-Host "Installing llvmenv"
          cargo install llvmenv --locked

          $llvmVersion = "18.1.8"
          Write-Host "Building LLVM $llvmVersion via llvmenv"
          llvmenv install $llvmVersion
          llvmenv global $llvmVersion

          $llvmPath = llvmenv prefix
          if (-not $llvmPath) {
            throw "llvmenv prefix returned an empty path"
          }

          $llvmBin = Join-Path $llvmPath "bin"
          $llvmConfig = Join-Path $llvmBin "llvm-config.exe"
          if (-not (Test-Path $llvmConfig)) {
            throw "llvm-config.exe was not found under $llvmPath. The llvm-sys crate requires it."
          }

          Write-Host "LLVM installed at: $llvmPath"
          "LLVM_SYS_181_PREFIX=$llvmPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LIBCLANG_PATH=$llvmBin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LLVM_HOME=$llvmPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LLVM_CONFIG_PATH=$llvmConfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$llvmBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "llvm-config version:"
          & $llvmConfig --version

          Write-Host "Clang version:"
          & (Join-Path $llvmBin "clang.exe") --version
      
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Cache Cargo dependencies (Windows)
        uses: actions/cache@v4
        if: ${{ matrix.os == 'windows-latest' }}
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build
        run: cargo build --verbose
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Build (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: cargo build --verbose
      
      - name: Run tests
        run: cargo test --verbose
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Run tests (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: cargo test --verbose
      
      - name: Build examples
        run: |
          cargo build --release
          find examples -name "*.ot" -type f | while read -r example; do
            cargo run --release -- run "$example" || true
          done
        if: ${{ matrix.os != 'windows-latest' }}
      
      - name: Build examples (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          cargo build --release
          $examples = Get-ChildItem -Path examples -Filter *.ot -Recurse
          if ($examples.Count -eq 0) {
            Write-Host "No .ot files found in examples directory"
            exit 0
          }
          foreach ($example in $examples) {
            Write-Host "Running example: $($example.FullName)"
            try {
              cargo run --release -- run $example.FullName
            } catch {
              Write-Host "Example $($example.Name) failed, continuing..."
            }
          }
